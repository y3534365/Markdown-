# 线性回归模型设计的流程

##  1.  明确需求

数据与处理(缺失值, 异常值, 哑变量)

### 1.缺失值

影响: 如果有缺失值, 模型会直接报错, 所有必须预先处理.

缺失值如果少, 你删了都无所谓, 如果太多了, 删了肯定不可能.第一个办法做随机游走, 让计算机在范围内任意取一个值, 整个空间内, 如果某一个维度的数字缺失了, 这个时候你可以根据其他维度的值, 大概估算出在这个维度的值大概是多少。

### 2.异常值

影响: 异常值会导致模型不准

异常值如果在三倍标准差以外, 就可以当做异常值.对于异常值的改变, 不一定要直接填平均值.

可以考虑的方法是, 可以调成三倍标准差的值, 是一个办法

### 3.哑变量

**注：这个就是老师说的那个把一列，分裂成很多个0/1列的那种方法**

在建模回归模型时, 如果自变量X为连续型变量, 回归系数可以解释为: 在其他自变量不变的情况下，X每改变一个单位，所引起的因变量Y的平均变化量；如果自变量X为二分类变量，例如是否饮酒（1=是，0=否），则回归系数β可以解释为：其他自变量不变的条件下，X=1（饮酒者）与X=0（不饮酒者）相比，所引起的因变量Y的平均变化量。

但是，当自变量X为多分类变量时，例如职业、学历、血型，疾病严重程度等，此时仅用一个回归系数，来解释多分类变量之间的关系，及其对因变量的影响，就显得不太理想。

此时，我们通常会将原始的多分类变量转化为哑变量，每个哑变量只代表某两个级别或若干个级别之间的差异，通过构建回归模型，每一个哑变量都能得出一个估计的回归系数，从而使得回归的结果更易于解释，更具有实际意义。

> 哑变量（Dummy Variable），又称为虚拟变量、虚设变量或名义变量，从名称上看就知道，它是人为虚设的变量，通常取值为0或1，来反映某个变量的不同属性。对于有n个分类属性的自变量，通常需要选取1个分类作为参照，因此可以产生n-1个哑变量。
>
> 将哑变量引入回归模型，虽然使模型变得较为复杂，但可以更直观地反映出该自变量的不同属性对于因变量的影响，提高了模型的精度和准确度。

#### 什么情况下需要设置哑变量

> 1. 对于无序多分类变量，引入模型时需要转化为哑变量
>
>    > 举一个例子，如血型，一般分为A、B、O、AB四个类型，为无序多分类变量，通常情况下在录入数据的时候，为了使数据量化，我们常会将其赋值为1、2、3、4。
>    >
>    > 从数字的角度来看，赋值为1、2、3、4后，它们是具有从小到大一定的顺序关系的，而实际上，四种血型之间并没有这种大小关系存在，它们之间应该是相互平等独立的关系。如果按照1、2、3、4赋值并带入到回归模型中是不合理的，此时我们就需要将其转化为哑变量。
>
>    ​

> 2. 对于有序多分类变量，引入模型时需要酌情考虑
>
>    > 例如疾病的严重程度，一般分为轻、中、重度，可认为是有序多分类变量，通常情况下我们也常会将其赋值为1、2、3（等距）或1、2、4（等比）等形式，通过由小到大的数字关系，来体现疾病严重程度之间一定的等级关系。
>    >
>    > 但需要注意的是，一旦赋值为上述等距或等比的数值形式，这在某种程度上是认为疾病的严重程度也呈现类似的等距或等比的关系。而事实上由于疾病在临床上的复杂性，不同的严重程度之间并非是严格的等距或等比关系，因此再赋值为上述形式就显得不太合理，此时可以将其转化为哑变量进行量化。

> 3. 对于连续性变量，进行变量转化时可以考虑设定为哑变量
>
>    > 对于连续性变量，很多人认为可以直接将其带入到回归模型中即可，但有时我们还需要结合实际的临床意义，对连续性变量作适当的转换。例如年龄，以连续性变量带入模型时，其解释为年龄每增加一岁时对于因变量的影响。但往往年龄增加一岁，其效应是很微弱的，并没有太大的实际意义。
>    >
>    > 此时，我们可以将年龄这个连续性变量进行离散化，按照10岁一个年龄段进行划分，如0-10、11-20、21-30、31-40等等，将每一组赋值为1、2、3、4，此时构建模型的回归系数就可以解释为年龄每增加10岁时对因变量的影响。
>    >
>    > 以上赋值方式是基于一个前提，即年龄与因变量之间存在着一定的线性关系。但有时候可能会出现以下情况，例如在年龄段较低和较高的人群中，某种疾病的死亡率较高，而在中青年人群中，死亡率却相对较低，年龄和死亡结局之间呈现一个U字型的关系，此时再将年龄段赋值为1、2、3、4就显得不太合理了。
>    >
>    > 因此，当我们无法确定自变量和因变量之间的变化关系，将连续性自变量离散化时，可以考虑进行哑变量转换。
>    >
>    > 还有一种情况，例如将BMI按照临床诊断标准分为体重过低、正常体重、超重、肥胖等几种分类时，由于不同分类之间划分的切点是不等距的，此时赋值为1、2、3就不太符合实际情况，也可以考虑将其转化为哑变量。

#### 如何选择哑变量的参照组

在上面的内容中我们提到，对于有n个分类的自变量，需要产生n-1个哑变量，当所有n-1个哑变量取值都为0的时候，这就是该变量的第n类属性，即我们将这类属性作为参照。

例如上面提到的以职业因素为例，共分为学生、农民、工人、公务员、其他共5个分类，设定了4哑变量，其中职业因素中“其它”这个属性，每个哑变量的赋值均为0，此时我们就将“其它”这个属性作为参照，在最后进行模型解释时，所有类别哑变量的回归系数，均表示该哑变量与参照相比之后对因变量的影响。

#### 在设定哑变量时，应该选择哪一类作为参照呢？

1. 一般情况下，可以选择有特定意义的，或者有一定顺序水平的类别作为参照

   例如，婚姻状态分为未婚、已婚、离异、丧偶等情况，可以将“未婚”作为参照；或者如学历，分为小学、中学、大学、研究生等类别，存在着一定的顺序，可以将“小学”作为参照，以便于回归系数更容易解释。

2. 可以选择临床正常水平作为参照

   例如，BMI按照临床诊断标准分为体重过低、正常体重、超重、肥胖等类别，此时可以选择“正常体重”作为参照，其他分类都与正常体重进行比较，更具有临床实际意义。

3. 还可以将研究者所关注的重点类别作为参照

   例如血型，分为A、B、O、AB四个类型，研究者更关注O型血的人，因此可以将O型作为参照，来分析其他血型与O型相比后对于结局产生影响的差异。

#### 设置哑变量时的注意事项

**1.** 原则上**哑变量在模型中应同进同出**，也就是说在一个模型中，如果同一个分类变量的不同哑变量，出现了有些哑变量有统计学显著性，有些无统计学显著性的情况下，为了保证所有哑变量代表含义的正确性，应当在模型中纳入所有的哑变量。

因此，我们在引入哑变量进入模型时，需选择Enter强制进入法，以保证所有哑变量都能保留在最后的模型中。

**2.** 上一期内容中我们介绍了如何选择参照，但需要注意的是，**被选为参照的那一类分组，应该保证有一定的样本量**。如果参照组样本量太少，则将会导致其他分类与参照相比时，参数估计的标准误较大，可信区间较大，精度降低，会出现估计参数极大或极小的现象。

### 4. 千万你带着缺失值和异常值去处理.

如题，很好理解。

----------

## 2. 相关分析(相关系数, 散点图)

不止要x对y画散点图, x对x之间也要画，就是老师说的那个看五千多张图的事。

## 3. 分测试集训练集

数据集的划分

1. 训练集（train Data）
2. 测试集（test Data）
3. 验证集（validation Data）--可有可无（商业领域一般会将最近期的数据作为验证数

据集）

你有一百万数据, 你先分出70%的数据别用, 等你建立完了, 你用30%的数据去测试你的模型。

而验证集，可以和训练集之间循环使用。吴老师讲过。

## 4. 回归(模型调优怎么调优, 对着马尔福假设残差调优, 先跑跑看看)

F检验, 如果不通过, 赶紧回头重做.
t检验, 每一个x你都要验一遍
R^2^，肯定也是需要的, 以及β系数看一下(主要看经验, 例如年龄和支出的关系应该是正的。)



## 5. 对于残差的分析, 以及模型调优

残差分析(正态性, 异方差性, 以及共线性, 序列相关性, 内生性)

1. 正态性验证：画QQ图看一下（检验判断）

    如果残差不符合正态性, 可以考虑做一下检验, **SW检验**和**KS检验**

    > KS用于样本数大于5000的检验
    > SW用于样本数小于5000的检验
    > 这两个假设都是H0是, "是正态分布的"

>  如果不能通过验证，可以进行Box-Cox变换, 一阶变换就是取自然对数, 

2. 异方差性验证：BP检验, White检验.

   >  BP检验
   >
   > White检验精度更高, 但是它会用掉大量自由度.例如模型里面并五六个自变量, 这个地方要有100多, 意思就是只能用于大样本的情况.

   原假设H0: 是同方差.
   H1:不是同方差
   如果结果P<0.05
   1) 第一个办法, 对外去对数 ln(y)
   2) 加权最小二乘(未必所有数据都可用加权最小二乘)(权重是由一个公式算的)

3. 共线性验证：看一眼VIF值, 如果某一个变量VIF值特别大, 就要考虑处理一下, 如果普遍比较大, 那么这时候我们有一些处理VIF值过大的办法.(这里是指普遍比较大的时候)

   > 第一个办法, 对x/y取对数
   >
   > 第二个办法, 主成分分析(PCA)。(跑完之后, 变量属性就会变化)（适合用于不关心原始变量属性的情况）
   >
   > 第三个办法, 岭回归, 或者/Lasso.优点:在相当程度上, 消除了共线性. 缺点: 如果你用了, 模型就一定有偏.具体偏差有多大, 你在测一下试试吧.
   > 如果只是其中一个比较大，就单独独处它。

4. 序列相关性验证：（如果数据带有时间趋势，则必须进行相关性检验）

   是用假设检验来验证的.目前徐老师接触过最好的, 是布罗施-高弗雷检验.GodFray test, 验的是残差是不是出现序列相关

   ​	H0: 无序列相关
   	H1: 有序列相关(如果出现H1, 唯一的解决办法, 可能就是差分)有好多教材推荐DW检验, 但是不要用.GodFray明显要高于DW检验.

5. 内生性验证：只能自己凭经验去感觉, 内生性是指x和u之间出现相关, 目前唯一的解决办法: 工具变量.所以在商业数据中, 内生性一般会被忽略的问题.

**模型调优(高次项可以加上, 交互项可以加, 这两个最基础的模型形式调优, 时间趋势和季节趋势(可以考虑, 如果需要的话))**

----
基本上手工能够调整的也就这么些事情

**下面是计算机能够帮你做的事情**

## 6. 计算机调优

### 逐步回归

#### 交叉验证

> (你有一百万数据, 分成10分, 来回测, 你可以得到10组参数, 然后你可以选择预测度最高的那组.)(你也可以抽样, 留着20%别用, 然后你用抽出的20%去验证, 理论上你可以测无数次)

## 7. 模型测试

用你的测试集去测试, 你的模型是不是OK

## 8. 以后这些步骤, 基本上你以后做商业模型的时候, 你肯定比这个步骤都, 不太可能更少了.

## 9. 以上步骤只针对于线性回归。












